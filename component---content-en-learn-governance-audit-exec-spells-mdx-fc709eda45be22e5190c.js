(window.webpackJsonp=window.webpackJsonp||[]).push([[95],{KP5y:function(e,t,n){"use strict";n.r(t),n.d(t,"_frontmatter",(function(){return s})),n.d(t,"default",(function(){return d}));var a=n("zLVn"),o=(n("q1tI"),n("7ljp")),c=n("z1h2"),s={},l={_frontmatter:s},i=c.a;function d(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(o.mdx)(i,Object.assign({},l,n,{components:t,mdxType:"MDXLayout"}),Object(o.mdx)("h1",null,"Auditing Executive Spells"),Object(o.mdx)("p",null,"This is a guide to help MKR Holders verify executive spells in the Maker Protocol before voting for them. "),Object(o.mdx)("p",null,"This document contains three main sections:"),Object(o.mdx)("ol",null,Object(o.mdx)("li",{parentName:"ol"},Object(o.mdx)("p",{parentName:"li"},"Finding the Contract Code deals with locating the code for the executive in question.")),Object(o.mdx)("li",{parentName:"ol"},Object(o.mdx)("p",{parentName:"li"},"Anatomy of a Spell Contract shows examples of the main sections you should expect to see in an executive spell.")),Object(o.mdx)("li",{parentName:"ol"},Object(o.mdx)("p",{parentName:"li"},"A Non-Exhaustive checklist includes a list of the major things to double check and how to do so."))),Object(o.mdx)("p",null,"The key thing to remember is that if any part of an executive spell seems suspicious or confusing in any way it is always better to double check before voting. Even if you are mistaken in your concerns, this allows us to add more detail to this document to prevent someone becoming confused in the same way in the future."),Object(o.mdx)("h2",null,"Finding the Contract Code"),Object(o.mdx)("p",null,"The link to the spell on etherscan can be found on the voting portal in the 'details' pane. Look for the 'source' property."),Object(o.mdx)("p",null,"Once you open the spell in etherscan, click on the Contract tab."),Object(o.mdx)("p",null,"You should see the contract code now. If you are only able to see bytecode (contract is unverified) then the executive should be viewed as potentially malicious. In this case, cry foul in chat and encourage people NOT to vote for it until the contract code is made available."),Object(o.mdx)("p",null,"For this document, we will be looking at this executive as our source for examples: ",Object(o.mdx)("a",Object.assign({parentName:"p"},{href:"https://etherscan.io/address/0xD24FbbB4497AD32308BDa735683B55499Ddc2CaD%E2%80%8B"}),"https://etherscan.io/address/0xD24FbbB4497AD32308BDa735683B55499Ddc2CaD​")),Object(o.mdx)("h2",null,"Anatomy of an Executive"),Object(o.mdx)("p",null,"The meat of each spell is located near the bottom. Most of the stuff at the top are flattened libraries included when the contract was verified."),Object(o.mdx)("p",null,"There are two contracts of note in each executive. These are the DssSpell contract and the SpellAction contract."),Object(o.mdx)("p",null,"In our example, the DssSpell contract is named ",Object(o.mdx)("inlineCode",{parentName:"p"},"DssSpell20200221")," in this example and is located at the bottom of the file. Once this spell ",Object(o.mdx)("inlineCode",{parentName:"p"},"0xD24FbbB4497AD32308BDa735683B55499Ddc2CaD")," gets enough votes to be lifted to the hat, the ",Object(o.mdx)("inlineCode",{parentName:"p"},"schedule()")," function you see here will be called."),Object(o.mdx)("p",null,"The spell action contract on the other hand includes the ",Object(o.mdx)("inlineCode",{parentName:"p"},"execute()")," function. This function contains the MCD variable changes that are included in the executive."),Object(o.mdx)("h3",null,"DssSpell"),Object(o.mdx)("h4",null,"Contract Variables"),Object(o.mdx)("p",null,"Each contract will contain a number of variables to be used in the other functions. In our example, this section looks like this:"),Object(o.mdx)("pre",null,Object(o.mdx)("code",Object.assign({parentName:"pre"},{}),"    DSPauseAbstract  public pause =\n        DSPauseAbstract(0xbE286431454714F511008713973d3B053A2d38f3);\n    address constant public SAIMOM = 0xF2C5369cFFb8Ea6284452b0326e326DbFdCb867C;\n    uint256 constant public NEW_FEE = 1000000002877801985002875644; // 9.5%\n    address          public action;\n    bytes32          public tag;\n    uint256          public eta;\n    bytes            public sig;\n    bool             public done;\n")),Object(o.mdx)("h4",null,"Constructor"),Object(o.mdx)("p",null,"The constructor should always look the same:"),Object(o.mdx)("pre",null,Object(o.mdx)("code",Object.assign({parentName:"pre"},{}),'    constructor() public {\n        sig = abi.encodeWithSignature("execute()");\n        action = address(new SpellAction());\n        bytes32 _tag;\n        address _action = action;\n        assembly { _tag := extcodehash(_action) }\n        tag = _tag\n    }\n')),Object(o.mdx)("h4",null,"Schedule and Cast"),Object(o.mdx)("p",null,"The schedule and cast functions will usually be the same, but for now any SCD changes will be tucked into schedule. If they deviate from the following, it will be commented:"),Object(o.mdx)("pre",null,Object(o.mdx)("code",Object.assign({parentName:"pre"},{}),'    function schedule() public {\n        require(eta == 0, "spell-already-scheduled");\n        eta = add(now, DSPauseAbstract(pause).delay());\n        pause.plot(action, tag, sig, eta);\n    }\n​\n    function cast() public {\n        require(!done, "spell-already-cast");\n        done = true;\n        pause.exec(action, tag, sig, eta);\n    }\n')),Object(o.mdx)("p",null,"After ",Object(o.mdx)("inlineCode",{parentName:"p"},"schedule")," has been called and after the delay is up, anyone can call ",Object(o.mdx)("inlineCode",{parentName:"p"},"cast()")," which will execute the code in the SpellAction's ",Object(o.mdx)("inlineCode",{parentName:"p"},"execute()")," function (see below)."),Object(o.mdx)("h3",null,"SpellAction"),Object(o.mdx)("h4",null,"Contract Variables"),Object(o.mdx)("p",null,Object(o.mdx)("inlineCode",{parentName:"p"},"uint256 constant RAD = 10 ** 45;"),"\n",Object(o.mdx)("inlineCode",{parentName:"p"},"address constant public PAUSE = 0xbE286431454714F511008713973d3B053A2d38f3;"),"\n",Object(o.mdx)("inlineCode",{parentName:"p"},"address constant public CHIEF = 0x9eF05f7F6deB616fd37aC3c959a2dDD25A54E4F5;"),"\n",Object(o.mdx)("inlineCode",{parentName:"p"},"address constant public OSM_MOM = 0x76416A4d5190d071bfed309861527431304aA14f;"),"\n",Object(o.mdx)("inlineCode",{parentName:"p"},"address constant public ETH_OSM = 0x81FE72B5A8d1A857d176C3E7d5Bd2679A9B85763;"),"\n",Object(o.mdx)("inlineCode",{parentName:"p"},"address constant public BAT_OSM = 0xB4eb54AF9Cc7882DF0121d26c5b97E802915ABe6;"),"\n",Object(o.mdx)("inlineCode",{parentName:"p"},"address constant public VAT = 0x35D1b3F3D7966A1DFe207aa4514C12a259A0492B;"),"\n",Object(o.mdx)("inlineCode",{parentName:"p"},"address constant public JUG = 0x19c0976f590D67707E62397C87829d896Dc0f1F1;"),"\n",Object(o.mdx)("inlineCode",{parentName:"p"},"address constant public POT = 0x197E90f9FAD81970bA7976f33CbD77088E5D7cf7;"),"\n",Object(o.mdx)("inlineCode",{parentName:"p"},"address constant public FLAP = 0xdfE0fb1bE2a52CDBf8FB962D5701d7fd0902db9f;"),"\n",Object(o.mdx)("inlineCode",{parentName:"p"},"uint256 constant NEW_BEG = 1.02E18; // 2%")),Object(o.mdx)("p",null,"NOTE: Review \"All SpellAction Contract Variables must be declared 'constant'\" in the checklist section below."),Object(o.mdx)("h4",null,"Execute"),Object(o.mdx)("p",null,"The ",Object(o.mdx)("inlineCode",{parentName:"p"},"execute()")," function will contain each MCD change that is being made in this executive spell."),Object(o.mdx)("pre",null,Object(o.mdx)("code",Object.assign({parentName:"pre"},{}),'function execute() external {\n    // drip\n    PotAbstract(POT).drip();\n    JugAbstract(JUG).drip("ETH-A");\n    JugAbstract(JUG).drip("BAT-A");\n​\n    // set the global debt ceiling to 183,000,000\n    VatAbstract(VAT).file("Line", mul(183000000, RAD));\n​\n    // set the ETH-A debt ceiling to 150,000,000\n    // https://vote.makerdao.com/polling-proposal/qmsm1q1hohyctsgxpbm44fomjoukf1d5g9lmpqraikmeoc\n    VatAbstract(VAT).file("ETH-A", "line", mul(150000000, RAD));\n​\n    // No Sai debt ceiling change this week.\n​\n    // set dsr to 8.0%\n    // Previously ETH SF was set to 8.0%, no change this week.\n    //  DSR rate was voted to a 0% spread, so we\'re bringing DSR up to match.\n    // https://vote.makerdao.com/polling-proposal/qmss9hnszwr6egq3xn6gpx4u8bz8cajja56rgtanjev1v8\n    PotAbstract(POT).file("dsr", 1000000002440418608258400030);\n​\n    // MCD Stability fee is currently at 8% and remains the same this week.\n    // https://vote.makerdao.com/polling-proposal/qmzgvzjm4xpm4b1tk2hxhdc6p8f4zqyju38pwqieatmhel\n​\n    // Lower the minimum flap auction bid increase to 2%\n    // https://vote.makerdao.com/polling-proposal/qmtsxrqavtczfsseytpypgqrz6z8zb613ikxwhqjv9ytzz\n    FlapAbstract(FLAP).file("beg", NEW_BEG);\n​\n    // Increase the Pause to 24 Hours\n    OsmAbstract(ETH_OSM).rely(OSM_MOM);\n    OsmAbstract(BAT_OSM).rely(OSM_MOM);\n    OsmMomAbstract(OSM_MOM).setAuthority(CHIEF);\n    OsmMomAbstract(OSM_MOM).setOsm("ETH-A", ETH_OSM);\n    OsmMomAbstract(OSM_MOM).setOsm("BAT-A", BAT_OSM);\n    DSPauseAbstract(PAUSE).setDelay(60 * 60 * 24);\n   }\n')),Object(o.mdx)("p",null,"The ",Object(o.mdx)("inlineCode",{parentName:"p"},"execute()")," function will be too large to go into detail, but each change should be well documented and one should make sure the code does what the comment says."),Object(o.mdx)("h2",null,"A Non-exhaustive Checklist"),Object(o.mdx)("h3",null,"Verify that the contract code is visible."),Object(o.mdx)("p",null,"Using the instructions above find the contract code on Etherscan and ensure that it is visible and verified."),Object(o.mdx)("h3",null,"Verify the Constructor, the Schedule, and the Cast functions mach templates."),Object(o.mdx)("p",null,"Each of these functions should match the templates shown above unless comments are included with the changes explaining why they do not conform to the expected templates."),Object(o.mdx)("h3",null,"Verify that the contents of the execute function are as expected"),Object(o.mdx)("p",null,"Make sure that you are seeing what you expected to see from the voting dashboard."),Object(o.mdx)("p",null,"Ensure that everything present is correct and that nothing is missing from this function."),Object(o.mdx)("h3",null,"Verify all addresses against the changelog"),Object(o.mdx)("p",null,"Any addresses you see in either of the above contracts should be verified against the most recent mainnet changelog. Currently MCD is at version 1.0.5, and the address list can be found here: ",Object(o.mdx)("a",Object.assign({parentName:"p"},{href:"https://changelog.makerdao.com/releases/mainnet/1.0.5/contracts.json%E2%80%8B"}),"https://changelog.makerdao.com/releases/mainnet/1.0.5/contracts.json​")),Object(o.mdx)("p",null,"To find the latest release you can look at ",Object(o.mdx)("a",Object.assign({parentName:"p"},{href:"https://changelog.makerdao.com/%E2%80%8B"}),"https://changelog.makerdao.com/​")),Object(o.mdx)("p",null,"In order to verify these, you should ensure that each address in the contract matches one of the addresses in the changelog."),Object(o.mdx)("p",null,"Note that in the example spell, there were SCD changes. Those are well documented and done with SaiMomAbstract(SAIMOM).setFee(NEW_FEE);. This calls a contract that has privileged access to make a few configuration changes in SCD."),Object(o.mdx)("p",null,"Verify the address of SAIMOM from the contract definition above. This is trickier, but you can put the SAIMOM address into etherscan: ",Object(o.mdx)("a",Object.assign({parentName:"p"},{href:"https://etherscan.io/address/0xF2C5369cFFb8Ea6284452b0326e326DbFdCb867C#code%E2%80%8B"}),"https://etherscan.io/address/0xF2C5369cFFb8Ea6284452b0326e326DbFdCb867C#code​")),Object(o.mdx)("h3",null,"Verifying Oracle Addresses"),Object(o.mdx)("p",null,"Occasionally, there are spells to do with Oracles - generally adding addresses to the whitelist, and occasionally adding a new kind of oracle (most recently the BTCUSD one). These addresses must also be carefully verified, and it can be non-obvious how to do so. However, if you follow the link to the changelog and look for PIP_ETH, you'll be on the right track."),Object(o.mdx)("p",null,"Open the ",Object(o.mdx)("inlineCode",{parentName:"p"},"Read")," tab of the PIP_ETH contract."),Object(o.mdx)("p",null,"Look for ",Object(o.mdx)("inlineCode",{parentName:"p"},"src")," (listed as number 7 currently)."),Object(o.mdx)("p",null,"Follow the contract address listed there and verify that it is indeed the ",Object(o.mdx)("inlineCode",{parentName:"p"},"MedianETHUSDcontract"),", and that the address here matches what is in the spell."),Object(o.mdx)("h3",null,"Verify Rate Changes"),Object(o.mdx)("p",null,"Rates are defined as per-second accumulation values. These values can be validated against the commented rate by using the bc command in a bash shell. Using the ",Object(o.mdx)("inlineCode",{parentName:"p"},"NEW_FEE")," variable in the example contract we have:"),Object(o.mdx)("p",null,Object(o.mdx)("inlineCode",{parentName:"p"},"bc -l <<< 'scale=27; e( l(1.095)/(60 * 60 * 24 * 365) )"),"\nThis produces 1.000000002877801985002875644, just drop the decimal place and you can see this matches the definition of ",Object(o.mdx)("inlineCode",{parentName:"p"},"NEW_FEE"),"."),Object(o.mdx)("p",null,"Validating all rate adjustments can be done the same way."),Object(o.mdx)("p",null,"For more information on the rates module, @vamsi wrote up a great post ",Object(o.mdx)("a",Object.assign({parentName:"p"},{href:"https://github.com/makerdao/developerguides/blob/master/mcd/intro-rate-mechanism/intro-rate-mechanism.mdare"}),"in the developer guides github")),Object(o.mdx)("h3",null,"Verify Timing"),Object(o.mdx)("p",null,"Occasionally, spells are set to execute at specific times, as in the case of shutting down SCD (check line 71 for an example). You can verify any UTC timestamp created in such spells using this handy tool."),Object(o.mdx)("h3",null,"Ensure Drip is called before Rates are changed."),Object(o.mdx)("p",null,"Before we change any of the rates, we must call ",Object(o.mdx)("inlineCode",{parentName:"p"},"drip")," on those respective contracts (e.g. if this is a DSR rate change, we call ",Object(o.mdx)("inlineCode",{parentName:"p"},"drip")," on the pot or if we are changing the SF of a collateral type, we have to call ",Object(o.mdx)("inlineCode",{parentName:"p"},'drip("ILK")')," on the ",Object(o.mdx)("inlineCode",{parentName:"p"},"jug"),")."),Object(o.mdx)("h3",null,"All SpellAction Contract Variables must be declared 'constant'"),Object(o.mdx)("p",null,"Because of how the ",Object(o.mdx)("inlineCode",{parentName:"p"},"SpellAction")," is called, it must never have anything in contract memory. That is, all the variables that look like they are contract variables in the example contract are actually declared as constant. "),Object(o.mdx)("p",null,"At execution time, the contract's variables will be that of the DSPauseProxy. If there are variables in this section that are anything other than constant then it is a MAJOR bug. If this is the case and the spell might look like it’s doing one thing but is actually doing another. and needs to be called out in maker chat. DO NOT vote for a spell with non-constant variables here."))}d.isMDXComponent=!0}}]);
//# sourceMappingURL=component---content-en-learn-governance-audit-exec-spells-mdx-fc709eda45be22e5190c.js.map